import{M as y,E as D}from"./types-Bm40F6nV.js";import{g as w,a as M,r as x,u as F,L as T}from"./main-xonCUAoo.js";import{L as U}from"./index-C3jYjnPP.js";import{c as W}from"./create-async-iterator-ggfG9U7o.js";import{setAdditionalGlobals as _}from"./set-additional-globals-CXY3m52s.js";import{useNavigation as $}from"./navigation-BRdOV7LN.js";import{setSafeAreaVars as j}from"./set-safe-area-vars-Bn-pRjCL.js";import{setTheme as G}from"./set-theme-Cu8raYyE.js";const A=/^rgba\(\s*(\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\s*\)$/,V=t=>{const e=t.match(A);return e?parseFloat(e[4])===0:!1},X=t=>{const e=(t==null?void 0:t.getElementById("root"))??(t==null?void 0:t.documentElement);if(!e)return null;const n=(u=>{const g=[u];for(;g.length>0;){const d=g.shift();if(!d)return null;const{backgroundColor:i}=getComputedStyle(d);if(!V(i))return i;for(let l of d.children)g.push(l)}return null})(e);return n||null},I=t=>{if(!t)return null;const e=t.scrollHeight??0,{height:r}=t.getBoundingClientRect(),n=Math.max(e,r);return Number.isFinite(n)&&n>0?n:null},q=t=>{var u,g;const e=Array.from(t.children).filter(d=>{const i=d.tagName;return i!=="SCRIPT"&&i!=="STYLE"});if(!e.length)return null;if(e.length===1)return I(e[0]);const r=(u=t.getBoundingClientRect)==null?void 0:u.call(t);let n=0;for(const d of e){const i=(g=d.getBoundingClientRect)==null?void 0:g.call(d);if(!i)continue;const l=r?r.top:0,c=i.bottom-l;n=Math.max(n,c)}return n>0?n:null},Y=t=>{if(!t)return null;const e=I(t.getElementById("root"));if(e)return e;const r=t.body;if(r){const n=q(r);if(n)return n;const u=I(r);if(u)return u}return I(t.documentElement)??I(t.scrollingElement)},H=new U({max:100,ttl:60*5e3}),J=["sediment://","file-service://"],K="/blank.svg",Q=({doc:t})=>{const e=t.contentWindow;if(!e)return;const r=Object.getOwnPropertyDescriptor(e.HTMLImageElement.prototype,"src");r&&Object.defineProperty(e.HTMLImageElement.prototype,"src",{set(n){var u,g,d,i,l;if(typeof n=="string"&&J.some(c=>n.startsWith(c))){const c=H.get(n);if(c){(u=r.set)==null||u.call(this,c);return}(g=r.set)==null||g.call(this,K),(i=(d=w()).getDownloadURL)==null||i.call(d,n).then(o=>{var f;H.set(n,o),(f=r.set)==null||f.call(this,o)}).catch(()=>{var o;(o=r.set)==null||o.call(this,"")})}else(l=r.set)==null||l.call(this,n)},get:r.get,configurable:!0,enumerable:!0})},Z=({doc:t})=>{const e=t.contentWindow;!e||!("console"in e)||e.addEventListener("pointerdown",r=>{for(const n of r.composedPath())n instanceof e.HTMLElement&&n.dataset.instrument&&w().sendInstrument({type:"count",label:`clicked.${n.dataset.instrument}`})},{passive:!0,capture:!0})},S=t=>{const e=t.trim().match(/(\d+):(\d+)\)?$/),r=parseInt((e==null?void 0:e.at(1))??""),n=parseInt((e==null?void 0:e.at(2))??"");return{lineno:r,colno:n}},O=(t,e)=>{var u;const r=[],n=t.split(`
`).slice(1)??[];for(let g=0;g<n.length;g++){const d=n[g],i=e(d);if(!i)break;const{source:l,line:c,column:o}=i;if(!(c==null||o==null))if(l!=null&&l.startsWith("internal")){const f=(u=e(n[g+1]))==null?void 0:u.name;f?r.push({line:c,column:o,formatted:`	at ${f} (module:${c}:${o})`}):r.push({line:c,column:o,formatted:d.replace(/(\(blob:.*\))$/,`(module:${c}:${o})`)})}else break}return r},z=({doc:t,sandboxLogger:e,onMessage:r,transformPosition:n})=>{const u=t.contentWindow;if(!u||!("console"in u))return;const g=l=>{if(!l)return null;const{lineno:c,colno:o}=S(l);return(n==null?void 0:n({line:c,column:o}))??null};u.addEventListener("unhandledrejection",({reason:l})=>{var c,o;if(typeof l=="object"&&"stack"in l){const f=O(l.stack,g);r({type:y.ERROR,line:((c=f[0])==null?void 0:c.line)??null,error:{line:((o=f[0])==null?void 0:o.line)??null,message:String(l.message??""),name:l.name??"Error",stack:f.map(({formatted:p})=>p)}})}}),u.addEventListener("error",({lineno:l,colno:c,error:o,message:f})=>{var a;const p=((a=n==null?void 0:n({line:l,column:c}))==null?void 0:a.line)??null;let s="",C=[];o&&typeof o=="object"&&"name"in o&&"stack"in o&&(s=o.name,C=O(o.stack,g).map(({formatted:m})=>m)),(s||f)&&r({type:y.ERROR,error:{line:p,message:f,name:s||"Error",stack:C},line:p})},{passive:!0,capture:!0});const d=u.console,i=(l,c)=>(o,...f)=>{var C,a;l(o,...f);let p;if(o&&typeof o=="object"&&"stack"in o&&typeof o.stack=="string"){const m=(C=o.stack)==null?void 0:C.split(`
`);p=(m==null?void 0:m[1])??(m==null?void 0:m[0])}else{const R=(new Error().stack??"").split(`
`);p=R[2]||R[1]}let s=null;if(p){const{lineno:m,colno:N}=S(p);s=((a=n==null?void 0:n({line:m,column:N}))==null?void 0:a.line)??null}try{c({line:s,error:o instanceof Error?o:null,args:o instanceof Error?f:[o,...f]})}catch(m){e.error("Failed to log",m)}};d.error=i(d.error,({line:l,args:c,error:o})=>{r({type:y.ERROR,line:l,error:o?{line:l,message:o.message,name:o.name,stack:[]}:{line:l,message:String(c[0]??""),name:"Error",stack:[]}}),c.length&&r({type:y.LOG,level:"info",line:l,log:c})}),d.log=i(d.log,({line:l,args:c})=>{r({type:y.LOG,level:"info",line:l,log:c})})},P=({doc:t})=>{t.contentWindow&&t.contentWindow.addEventListener("securitypolicyviolation",e=>{const r={effectiveDirective:e.effectiveDirective,violatedDirective:e.violatedDirective,blockedURI:e.blockedURI,sourceFile:e.sourceFile};w().notifySecurityPolicyViolation(r)})},tt="html,body,#root{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}html,body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Helvetica Neue,Arial,sans-serif!important}button,input,textarea,select{font-family:inherit}",et=t=>{try{const e=t.createElement("style");e.textContent=tt.trim(),t.head.appendChild(e)}catch{}};async function*dt({sandboxLogger:t,html:e,theme:r,safeArea:n,transformPosition:u,additionalGlobals:g,expectReadySignal:d}){let i=null,l=null;yield*W((c,o)=>{const f=a=>{c(a),a.type===y.RUN_COMPLETE&&o()};t.time("html.evaluation");const p=M(),s=x(),C=()=>{if(!s.contentDocument||!s.contentWindow)return;const a=s.contentDocument;(g||n)&&_({root:s,additionalGlobals:Object.assign(g??{},{safeArea:n}),sandboxLogger:t,isInit:!0}),a.open(),F({doc:s}),$({doc:s}),P({doc:s}),Z({doc:s}),z({doc:s,sandboxLogger:t,transformPosition:u,onMessage:f}),Q({doc:s});let m=null,N=null;const R=()=>{p==null||p.remove(),t.timeEnd("html.evaluation"),f({type:y.ENVIRONMENT_STATUS,status:D.RUNNING_CODE})},L=()=>{i==null||i.disconnect(),l==null||l.disconnect(),f({type:y.RUN_COMPLETE,duration:null,wasCancelled:!1,wasFatalError:!0})},v=()=>{var h,b;const E=Y(a);E&&E!==N&&((b=(h=w()).notifyIntrinsicHeight)==null||b.call(h,E),N=E)},B=()=>{var h,b;const E=X(a);E!=null&&E!==m&&((b=(h=w()).notifyBackgroundColor)==null||b.call(h,E),m=E)};a.write(e);const k=a.documentElement;et(a),l=new ResizeObserver(()=>{v()}),i=new MutationObserver(E=>{for(const h of E)if(h.target===k){if(h.attributeName==="data-ready"&&k.hasAttribute("data-ready")){R();break}else if(h.attributeName==="data-fatal"&&k.hasAttribute("data-fatal")){L();break}}else if(h.addedNodes.length===0&&h.removedNodes.length>0&&h.target.parentElement===a.body&&h.target.childNodes.length===0&&Array.from(a.body.childNodes).every(b=>b===h.target||nt(b))){L();break}B(),v()}),T&&(k.lang=T),r&&G({theme:r,doc:s}),n&&j({doc:s,safeArea:n}),l.observe(k,{box:"border-box"}),i.observe(k,{childList:!0,attributes:!0,subtree:!0}),a.close(),R(),k.hasAttribute("data-ready")&&R()};if(s.addEventListener("load",C,{once:!0}),s.src="about:blank",s.parentElement){const a=new MutationObserver(()=>{s.isConnected||(a==null||a.disconnect(),l==null||l.disconnect(),i==null||i.disconnect(),f({type:y.RUN_COMPLETE,duration:null,wasCancelled:!1,wasFatalError:!1}))});a.observe(s.parentElement,{childList:!0,attributes:!0,subtree:!0})}})}function nt(t){var e;return t.nodeType===Node.COMMENT_NODE?!0:t.nodeType===Node.TEXT_NODE?!((e=t.textContent)!=null&&e.trim()):t.nodeType===Node.ELEMENT_NODE?t.childNodes.length===0:!0}export{dt as runHTMLAsync};
